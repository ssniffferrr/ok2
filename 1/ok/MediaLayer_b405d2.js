define(["jquery","OK/logger","OK/utils/utils","OK/utils/dom","OK/OhManager","OK/utils/vanilla"],(function(e,t,o,a,n,r){"use strict";var i;OK.onload.addCallback((function(){i=!0}));var s,c,l,d,f,u,p,v=null,h=null,_="mtLayer",g="media-layer_fixer",m=null,y=null,O=null,w=null,C=null,T=null,L=null,k=null,K=null,M={id:null,to:75},b="MediaTopicLayerBody",A="MediaTopicLayerAd",B="AnonymMediaTopicLayerAd",I="layer__disabled",P="invisible",H="data-banner-seq-show-count",S=!1,E=!1,R=null,j=o.deferred();function D(e,t){var o,a=document.getElementById(e);if(!a)return!1;for(o=0;o<t.length;o+=1)if(a.classList.contains(t[o]))return!1;return!0}function x(){return s.isActive&&!e("#hook_Block_PopLayerMediaTopic").hasClass(I)}function N(e){if(x()){if(E||m[0]===document.activeElement||0!==m.find(document.activeElement).length||(m.focus(),E=!0),m.hasClass("__edit")||m.find(".__edit").length>0)return;if(m.find(".tag-box__editable").length>0)return;if(D("hook_Modal_popLayerModal",[I]))return;if(D("photoLayerWrapper",[I,P]))return;if(D("video-poplayer-cnt",[I,P]))return;39===e.keyCode&&k?(k.click(),OK.stop(e)):37===e.keyCode&&L&&(L.click(),OK.stop(e))}}function q(e){e?OK.Layers.register(_,(function(){se("cr_esc")}),void 0,!1,N):OK.Layers.remove(_)}function J(e,t){OK.loader.use("OKCustomJs",(function(){e&&q(t),t?OK.Layers.onLayerShown&&OK.Layers.onLayerShown():OK.Layers.onLayerHidden&&OK.Layers.onLayerHidden()}))}function F(){var e="media-layer js-viewport-container";s.market&&""==s.pfMode?e+=" product-layer":e+=" media-layer__topic",s.modernLayer&&(e+=" __modern"),s.v2&&(e+=" __v2"),s.pfJs&&(e+=" __posting"),s.isActive&&(e+=" __active"),s.isProcess&&(e+=" __process"),s.isProcessTransparent&&(e+=" __process-transparent"),"N"==s.pfMode&&(e+=" __create"),"E"==s.pfMode&&(e+=" __edit"),s.hasActiveTopics&&(e+=" __has-topics"),s.arrowsHidden&&(e+=" __hide-arrows"),s.hasBanner&&(e+=" __has-banner"),s.fullScreen&&(e+=" __full-screen"),m[0].className=e}function V(){J(!0,s.isActive),n.switchLayer(!!s.isActive),F();var e=_e();if(e){var t=document.getElementById(e+"Config");if(t){var o=t.getAttribute("data-slot");s.isActive?(m.attr(H,0),require(["OK/banners/BannerLoader"],(function(e){d=e.subscribeToEvents(o,{onAdsSuccess:W,onNoAds:U,onScriptError:U,onHideBanner:U})}))):(d&&"function"==typeof d.remove&&d.remove(),G(e),Y(!1))}}}function W(e){Y(!0)}function U(e){Y(!1)}function G(e){var t=document.getElementById(e+"Wrapper");t&&(t.innerHTML="")}function z(e){var t=parseInt(m.attr(e),10);return isNaN(t)&&(t=0),t}function $(t){var o=s.isActive!==t;s.isActive=t,o?V():s.isActive&&e("#hook_Block_PopLayerMediaTopic").hasClass(I)&&J(!1,!0),document.getElementById("hook_Block_PopLayerMediaTopic").classList.remove(I)}function Q(e){var t=s.isProcess!==e;s.isProcess=e,t&&F()}function X(e){var t=s.pfMode!==e;s.pfMode=e,t&&F()}function Y(e){if(s){var t=s.hasBanner!==e;s.hasBanner=e,t&&F(),m.attr(H,e?1:0)}}function Z(e){y.toggleClass("__process",e)}function ee(e,t){for(var o=e.length,a=o;1+--o;)e[o].toggleClass(t);setTimeout((function(){for(;1+--a;)e[a].toggleClass(t)}),1)}function te(){if(w){var t=0;e(".comments_i",w).each((function(){var o=e(this).data("unread");return o&&(t=this.getBoundingClientRect().top),!o})),m.each((function(){this.scrollTop=0!==t?this.scrollTop+t:this.scrollHeight})),setTimeout((function(){e(".js-comments_add",w).focus()}),50)}}function oe(t,o,a){var n=e(window),r=n.height(),i=n.width();M.id&&clearTimeout(M.id),M.id=setTimeout((function(){ee([C,k,L,K],g),M.id=null}),t?0:M.to),m.toggleClass("__compact",i<=1145),m.toggleClass("__min-height",r<310),o&&te(),a&&function(e){if(e){var t=m.find("[data-scroll-to='"+e+"']");if(t.length>0){for(var o=t[0],a=o.offsetTop,n=o.offsetParent;n&&1===n.nodeType&&n!==m[0];)a+=n.offsetTop,n=n.offsetParent;var r=m,i=r.height(),s=r.scrollTop(),c=i;s+i<=a+c?r.scrollTop(a+c-i-5):s>a&&r.scrollTop(a-5)}}}(a)}function ae(t){S||(S=!0,v=e(window),h=e(document.body),m=e("#mtLayer"),y=e("#mtLayerMain"),L=e("#mtLayerBack"),k=e("#mtLayerForward"),K=e("#scrollToTopMtLayer"),s={fullScreen:m.hasClass("__full-screen"),isActive:m.hasClass("__active"),isProcess:m.hasClass("__process"),isProcessTransparent:m.hasClass("__process-transparent"),pfMode:m.hasClass("__edit")?"E":m.hasClass("__create")?"N":"",pfJs:m.hasClass("__posting"),modernLayer:m.hasClass("__modern"),v2:m.hasClass("__v2"),hasActiveTopics:m.hasClass("__has-topics"),hasBanner:m.hasClass("__has-banner"),arrowsHidden:m.hasClass("__hide-arrows")},O=m.find(".media-layer_hld"),C=O.find(".media-layer_close"),T=m.find(".media-layer_close_ovr"),m.on("click",(function(e){a.parent(e.target,"js-mlr-block",!1,!0)||se("cr_shadow")})),C.on("click",(function(e){se("cr_close")})),s.isActive&&(V(),s.isProcess||oe(!0,t)),t&&te(),v.on("resize.mtLayer",(function(){oe()})),j.resolve(m))}function ne(t){if(OK.historyManager.isHistorySupported()){var o=t.indexOf("?");o>0?(p=t.substr(o+1),u=t.substr(0,o),u=decodeURIComponent(u),p.length>0?p+="&mt.scrollTop="+e(window).scrollTop():p=null,r=u,null!=(i=p)&&0!=i.length&&OK.historyManager.putItemToCache(r,i)):(u=t,p=null);var a,n=re()==u&&!l;f?a=!s.closeTopicId:(n?a=!0:l&&ie(l,!0),f=re()),l="",n||ie(u,a)}var r,i}function re(){return OK.historyManager.getState()}function ie(e,t){t?OK.historyManager.replaceState(e):OK.historyManager.pushState(e)}function se(e,t){if("cr_shadow"!=e||""==s.pfMode){if(""!=s.pfMode&&!t&&("cr_esc"===e||"cr_close"===e)){var o=m.find(".posting");if(o.length>0){var a=o[0].okPosting;if(a)return void(a.needConfirmBeforeClose()?a.showCloseConfirmDialog():a.closeWithoutConfirmDialog())}}if(s.confirmCloseOffer)return s.confirmCloseOffer=!1,void r.ajax({url:OK.getCurrentStateLink(),data:{cmd:"PopLayer","st.layer.cmd":"ConfirmCloseOffer","st.layer.offerId":s.topicId}}).then(r.updateBlockModelCallback);E=!1,s.topicId=null,s.owner=null;var n=s.closeTopicId,i=s.closeOwnerType;if(s.closeTopicId=null,s.closeOwnerType=null,n&&("cr_esc"===e||"cr_shadow"===e||"cr_close"===e||"cr_fail"===e))return e&&ce(e+"_ct"),void setTimeout((function(){OK.historyManager.isHistorySupported()?OK.historyManager.back():ge(n,i,"")}),0);var c=!1;x()&&f&&u==re()&&(f==u?(c=!0,OK.historyManager.back()):ie(f,!0)),c||($(!1),Q(!1),X(""),Z(!1),le(),de(),K.removeClass("__active __animated"),OK.hookModel.setHookContent(b,"")),f=null,e&&ce(e),m.trigger("mtLayer.close")}}function ce(e){t.success("mtlayer",c||"",e)}function le(){L.removeClass("__active"),k.removeClass("__active")}function de(){var e=h,t=e.find(".gwt-shortcutMenu__show");t.length&&t.removeClass("gwt-shortcutMenu__show");var o=e.find(".sc-menu:not(.sc-menu__hidden,.poll_ans_cnt)");o.length&&(o=o.not("#ownProfileLSMnu")).addClass("sc-menu__hidden")}var fe=[0,1,2,3,5,8,13,21,34,55,89,144,233,377,610];function ue(e,t){var o,a=(t-e)/100;for(o=1;o<fe.length&&!(a<fe[o]);o++);return fe[o-1]+"00"}function pe(){m&&m.scrollTop(0)}function ve(e){s.isProcess?Q(!1):Z(!1),e&&e()}function he(t,o,a,n,r){l=o,ae(a);var i=e("#MediaTopicLayerBody");s.market="true"==i.attr("data-market"),s.advertSelectionId=i.attr("data-adv-sel-id"),s.modernLayer="true"===i.attr("data-modernLayer"),s.v2="true"===i.attr("data-v2"),s.fullScreen="true"===i.attr("data-full-screen");var c=i.attr("data-log");c&&ce(c);var d=i.attr("data-pf-mode");X(d||!1),function(e){var t=s.pfJs!==e;s.pfJs=e,t&&F()}("true"===i.attr("data-pf-js"));var v,h,_,y,C=i.attr("data-url");if(C?ne(C):(f||u!=re()||ie(f,!0),f=null,u=null,p=null),s.closeTopicId||n);else{var T=i.attr("data-back-id");_=T,y=t,L&&(L.toggleClass("__active",!!_&&!!y),L.unbind("click.back").bind("click.back",(function(e){if(L.hasClass("__active")){var t=k.hasClass("__active");ge(_,y,"MT_GoBack_"+y,!1,"","BACK",t)}OK.stop(e)})));var M=i.attr("data-forward-id");v=M,h=t,k&&(k.toggleClass("__active",!!v&&!!h),k.unbind("click.forward").bind("click.forward",(function(e){if(k.hasClass("__active")){var t=L.hasClass("__active");ge(v,h,"MT_GoForward_"+h,!1,"","FORWARD",t)}OK.stop(e)})))}var b=i.attr("data-id");b&&(s.topicId=b,s.owner=t),"OFFER"===t&&(R=m.find(".js-offer-save-button")).length&&(s.confirmCloseOffer=!0,R.on("click",(function(){s.confirmCloseOffer=!1})));var A=i.attr("data-log-click");A?m.attr("data-l",A):m.removeAttr("data-l");var B=O.find(".js_mediaLayerActions");if(B.length>0){var I=function(t){var o=t.delegateTarget.getAttribute("data-url"),a=t.delegateTarget.getAttribute("uid");o&&(a?e.ajax({type:"POST",url:o,data:{"gwt.requested":window.pageCtx.gwtHash},headers:{TKN:OK.tkn.get()}}).done((function(e,t,o){B.children().unbind("click.advert"),me("PLAdvertStatusBackToView",(function(){O.find(".js_mediaLayerActions").children().bind("click.advert",I)}))})):window.navigateOnUrlFromJS(o));OK.stop(t)};B.children().bind("click.advert",I)}s.isProcess||F(),ve(r),ee([k,L,K],g),pe(),w=O.find(".mlr_disc"),O.find(".sticky-plank_cnt"),oe(!0,a,i.attr("data-scroll-to-marker"))}function _e(){return document.getElementById("hook_Block_MediaTopicLayerAd")?A:document.getElementById("hook_Block_AnonymMediaTopicLayerAd")?B:null}function ge(o,a,n,d,f,u,p,v,h,g,y,O){ae(d);var w,C=Date.now(),T=-1,K=-1;function M(e){var o=Date.now(),a="";if(e&&(a+="r_"),ce((a+=u?"dt":"ot")+ue(C,o)),w&&ce("js_"+a+ue(w,o)),s.pfMode){var n=o-C,r=T-C,l=K-T,d=o-K,f=c||"",p=OK.getCurrentDesktopModelId&&OK.getCurrentDesktopModelId(),v=(s.pfJs?"js.":"gwt.")+(i?"f.":"p.")+(p||"");if(n>0){var h=window.__gwtStatsEventsLog;if(h&&h.bootstrap&&h.bootstrap.begin){var _=C-h.bootstrap.begin,g=Math.floor(_/1e3),m=Math.floor(g/60),y=Math.floor(m/60);v+=y>0?".h"+y:m>=20?".m"+20*Math.floor(m/20):m>=10?".m10":m>=5?".m5":3>=m&&m>0?".m"+m:g>=20?".s"+20*Math.floor(g/20):".s"+10*Math.floor(g/10),t.duration("mtlayer",_,"start."+f+"."+s.pfMode,v)}t.duration("mtlayer",n,f+"."+s.pfMode,v),r>0&&(t.duration("mtlayer",r,"net."+f+"."+s.pfMode,v),t.duration("mtlayer",l,"act."+f+"."+s.pfMode,v),t.duration("mtlayer",d,"bnr."+f+"."+s.pfMode,v))}else t.duration("mtlayer",o-C,f+"."+s.pfMode,v+"_wtf")}}u||(s.closeTopicId=null,s.closeOwnerType=null),n&&-1!==n.indexOf("st.mt.or=on")&&(h=s.topicId,g=s.owner),OK.photoLayer&&OK.photoLayer.close(),OK.VideoPlayer.pauseAll(),require.defined("OK/dailyphoto/dailyphoto-model")&&require(["OK/dailyphoto/dailyphoto-model"],(function(e){e.togglePlayer&&e.togglePlayer(!1)})),OK.loader.use("OKCustomJs",(function(){var e=OK.Layers.stack;!(e&&e.length>0&&e[e.length-1].id===_)&&s.isActive&&q(!0)})),c=a,(l=f)&&ce("shortlink"),le(),s.isActive&&!s.isProcess?(Z(!0),de()):Q(!0),$(!0);var I=OK.getCurrentStateLink();I=(I+=-1===I.indexOf("?")?"?":"&").replace(/st\.mt\.(id|ot|bi|dir|hn|c7).*?(&|$)/g,""),I+="cmd=MediaTopicLayerBody",n&&(I+="&st._aid="+n);var P=function(e){var t=_e();if(!t||!s.isActive)return!1;if(e){var o=document.getElementById(t+"Config");if(o){var a=o.getAttribute("data-everyNDisplay");if(a){var n=z(H);return 0===n||n%a==0}}}return!0}(!!u),S={"gwt.requested":window.pageCtx.gwtHash,"st.mt.id":o,"st.mt.ot":a,"st.mt.dir":u,"st.mt.wc":v?"on":"off","st.mt.hn":y?"on":"off","st.mt.ad":P?"on":"off","st.mt.bi":O||0,"st.mt.as":s.advertSelectionId},E=e.ajax({type:"POST",url:I,data:S,headers:{TKN:OK.tkn.get()}});return E.done((function(e,t,o){w=Date.now(),h&&(s.closeTopicId=h,s.closeOwnerType=g);var n,i=o.getResponseHeader("Redirect-Location");if(i){var c=function(e){OK.navigation.redirect&&OK.navigation.redirect(i),0===e||OK.navigation.redirect?(se(),M()):setTimeout((function(){c(e-1)}),200)};c(5)}else{if("yes"===o.getResponseHeader("End-Reached"))return"FORWARD"===u?p&&L.toggleClass("__active",!0):"BACK"==u&&p&&k.toggleClass("__active",!0),void ve(M);T=Date.now();for(var f,v=e.split(OK.navigation.SPLITER),_=o.getResponseHeader(OK.navigation.HEADER).split(","),O=0;O<v.length;O++){var C=_[O];if(C){var I=v[O];OK.hookModel.setHookContent(C,I),C!==A&&C!==B||(f=I)}}K=Date.now(),function(e,t){if(e){var o=document.createElement("div");o.innerHTML=e,0===o.getElementsByClassName("media-layer_ads").length&&Y(!1)}else{"true"===document.getElementById(b).getAttribute("data-hide-ad")?(G(_e()),Y(!1)):t&&s.hasBanner&&(n=z(a=H),m.attr(a,n+1))}var a,n}(f,u),he(a,l,d,y,M)}(n=document.querySelector(".js-mediatopic-widget"))&&r.trigger(n,"refreshMediatopicWidget")})),E.fail((function(){se("cr_fail"),M()})),E}function me(t,o){function a(){o&&o()}if(s&&s.topicId&&s.owner){var n=OK.getCurrentStateLink();n+=-1===n.indexOf("?")?"?":"&",n+="cmd=MediaTopicLayerBody&st._aid="+t;var r=e.ajax({type:"POST",url:n,data:{"gwt.requested":window.pageCtx.gwtHash,"st.mt.id":s.topicId,"st.mt.ot":s.owner},headers:{TKN:OK.tkn.get()}});r.done((function(e,t,o){var n=o.getResponseHeader("Redirect-Location");if(n)OK.navigation.redirect&&OK.navigation.redirect(n),se();else for(var r=e.split(OK.navigation.SPLITER),i=o.getResponseHeader(OK.navigation.HEADER).split(","),s=0;s<r.length;s++)i[s]&&OK.hookModel.setHookContent(i[s],r[s]);a()})),r.fail(a)}else a()}return{show:function(){ae(),$(!0),pe()},showPreloaded:he,showTopicInLayer:ge,closeLayer:function(e,t){S&&se(e,t)},hideLayer:function(){E=!1,s&&s.isActive&&(f&&re()==u&&ie(f,!0),J(!1,!1))},restoreLayer:function(){s&&s.isActive&&(ee([C,k,L,K],g),f&&re()!==u&&ie(u,!0),J(!1,!0))},isVisible:function(){return s&&x()},setVisible:function(e){s&&s.owner&&e!==this.isVisible()&&$(e)},refreshLayerBody:function(e){me("PLPhotoUserBackToView",e)},deactivate:function(){e(window).off(".mtLayer"),C&&C.off(),T&&T.off(),R&&R.off(),$(!1)},updateActiveTopics:function(e,t,o){j.promise.then((function(a){s.hasActiveTopics=t,s.arrowsHidden=o;var n=e.getHeight(),r=y.outerHeight(!0);t?r<n?y.css("min-height",n):r-n<100&&e.setHeight(r):y.css("min-height",""),F()}))}}}));
//# sourceMappingURL=/res/source-maps/js/app/MediaLayer.js.map